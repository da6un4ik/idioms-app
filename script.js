const IDIOM_DATA = [
    {
        id: 1,
        text: "Ser pan comido",
        meaning: "–ü—Ä–æ—â–µ –ø—Ä–æ—Å—Ç–æ–≥–æ (—Ä–∞–∑ –ø–ª—é–Ω—É—Ç—å).",
        example: "No te preocupes por el examen, ¬°ser√° pan comido!",
        image: "assets/images/ser_pan_comido.jpg", 
        audio_main: "assets/audio/ser_pan_comido.mp3",
        audio_example: "assets/audio/example_pan_comido.mp3",
        category: "–õ–µ–≥–∫–æ—Å—Ç—å",
        exercises: [
            { id: "ex1_1", type: "–í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è", question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–∞ –∏–¥–∏–æ–º–∞?", options: ["–û—á–µ–Ω—å –≤–∫—É—Å–Ω–æ", "–û—á–µ–Ω—å –ª–µ–≥–∫–∏–º", "–û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–º"], answer: "–û—á–µ–Ω—å –ª–µ–≥–∫–∏–º" },
            { id: "ex1_2", type: "–í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞", question: "–î–æ–ø–æ–ª–Ω–∏ —Ñ—Ä–∞–∑—É:", prompt: "El examen es pan ___.", answer: "comido" },
            { id: "ex1_4", type: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", question: "–°–æ–±–µ—Ä–∏ —Ñ—Ä–∞–∑—É:", words: ["SER√Å", "PAN", "COMIDO"], answer: "SER√Å PAN COMIDO" },
            { id: "ex1_5", type: "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç", dialogue: "‚Äî ¬øCrees que el test es dif√≠cil?", question: "–û—Ç–≤–µ—Ç:", options: ["No, es pan comido.", "S√≠, pan."], answer: "No, es pan comido." }
        ]
    },
    {
        id: 2,
        text: "Estar en las nubes",
        meaning: "–í–∏—Ç–∞—Ç—å –≤ –æ–±–ª–∞–∫–∞—Ö (–±—ã—Ç—å —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–º).",
        example: "¬°Escucha! Siempre est√°s en las nubes.",
        image: "assets/images/estar_en_las_nubes.jpg", 
        audio_main: "assets/audio/estar_en_las_nubes.mp3",
        audio_example: "assets/audio/example_nubes.mp3",
        category: "–í–Ω–∏–º–∞–Ω–∏–µ",
        exercises: [
            { id: "ex2_1", type: "–í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è", question: "–ß—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —ç—Ç–∞ –∏–¥–∏–æ–º–∞?", options: ["–õ–µ—Ç–∞—Ç—å –Ω–∞ —Å–∞–º–æ–ª–µ—Ç–µ", "–ë—ã—Ç—å —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–º", "–õ—é–±–∏—Ç—å –ø–æ–≥–æ–¥—É"], answer: "–ë—ã—Ç—å —Ä–∞—Å—Å–µ—è–Ω–Ω—ã–º" },
            { id: "ex2_2", type: "–í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞", question: "–î–æ–ø–æ–ª–Ω–∏ —Ñ—Ä–∞–∑—É:", prompt: "Escucha, ¬°siempre est√°s en las ___!", answer: "nubes" },
            { id: "ex2_4", type: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", question: "–°–æ–±–µ—Ä–∏ —Ñ—Ä–∞–∑—É:", words: ["SIEMPRE", "EST√ÅS", "EN", "LAS", "NUBES"], answer: "SIEMPRE EST√ÅS EN LAS NUBES" },
            { id: "ex2_5", type: "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç", dialogue: "‚Äî ¬øPor qu√© no me contestas?", question: "–û—Ç–≤–µ—Ç:", options: ["Perd√≥n, estaba en las nubes.", "S√≠, las nubes son bonitas."], answer: "Perd√≥n, estaba en las nubes." }
        ]
    },
    {
        id: 3,
        text: "Tirar la casa por la ventana",
        meaning: "–°–æ—Ä–∏—Ç—å –¥–µ–Ω—å–≥–∞–º–∏ (–≥—É–ª—è—Ç—å –Ω–∞ –≤—Å—é –∫–∞—Ç—É—à–∫—É).",
        example: "Para su boda, tiraron la casa por la ventana.",
        image: "assets/images/casa_ventana.jpg", 
        audio_main: "assets/audio/casa_ventana.mp3",
        audio_example: "assets/audio/example_ventana.mp3",
        category: "–î–µ–Ω—å–≥–∏",
        exercises: [
            { id: "ex3_1", type: "–í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è", question: "–í –∫–∞–∫–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏ —ç—Ç–æ –≥–æ–≤–æ—Ä—è—Ç?", options: ["–ü—Ä–∏ –ø–µ—Ä–µ–µ–∑–¥–µ", "–ü—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ç—Ä–∞—Ç–∞—Ö", "–ü—Ä–∏ —Ä–µ–º–æ–Ω—Ç–µ"], answer: "–ü—Ä–∏ –±–æ–ª—å—à–∏—Ö —Ç—Ä–∞—Ç–∞—Ö" },
            { id: "ex3_2", type: "–í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞", question: "–î–æ–ø–æ–ª–Ω–∏ —Ñ—Ä–∞–∑—É:", prompt: "Tiraron la casa por la ___.", answer: "ventana" },
            { id: "ex3_4", type: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä", question: "–°–æ–±–µ—Ä–∏ —Ñ—Ä–∞–∑—É:", words: ["TIRARON", "LA", "CASA", "POR", "LA", "VENTANA"], answer: "TIRARON LA CASA POR LA VENTANA" },
            { id: "ex3_5", type: "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç", dialogue: "‚Äî ¬°Vaya fiesta de cumplea√±os!", question: "–û—Ç–≤–µ—Ç:", options: ["S√≠, han tirado la casa por la ventana.", "No, la ventana est√° cerrada."], answer: "S√≠, han tirado la casa por la ventana." }
        ]
    }
];

let favorites = JSON.parse(localStorage.getItem('idioms_favs')) || [];

function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('#bottom-nav button').forEach(b => b.classList.remove('active'));
    
    document.getElementById(`screen-${id}`).classList.add('active');
    const navBtn = document.querySelector(`button[data-screen="${id}"]`);
    if(navBtn) navBtn.classList.add('active');

    if(id === 'dashboard') renderDashboard();
    if(id === 'favorites') renderFavorites();
    if(id === 'catalog') renderCatalog();
    window.scrollTo(0,0);
}

function playAudio(path) {
    new Audio(path).play().catch(() => console.log("Audio file missing"));
}

function toggleFavorite(id, event) {
    if(event) event.stopPropagation();
    const index = favorites.indexOf(id);
    if (index > -1) favorites.splice(index, 1);
    else favorites.push(id);
    
    localStorage.setItem('idioms_favs', JSON.stringify(favorites));
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–∏–¥
    if(document.getElementById('screen-dashboard').classList.contains('active')) renderDashboard();
    if(document.getElementById('screen-favorites').classList.contains('active')) renderFavorites();
}

function renderDashboard() {
    const dash = document.getElementById('screen-dashboard');
    const hero = IDIOM_DATA[0];
    dash.innerHTML = `
        <div class="netflix-hero" style="background-image: linear-gradient(to top, #141414 15%, transparent), url('${hero.image}');">
            <div class="hero-content">
                <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                    <span style="background:#E50914; color:white; padding:2px 6px; border-radius:2px; font-size:12px; font-weight:bold;">N</span>
                    <span style="letter-spacing:2px; font-size:11px; color:#aaa; font-weight:bold;">–ò–î–ò–û–ú–ê –î–ù–Ø</span>
                </div>
                <h1 style="margin:0 0 15px 0; font-size:32px;">${hero.text}</h1>
                <div style="display:flex; gap:10px;">
                    <button class="check-btn" style="width:auto; padding:10px 25px;" onclick="renderDetail(${hero.id})">‚ñ∂ –ò–∑—É—á–∞—Ç—å</button>
                    <button class="check-btn" style="width:auto; padding:10px 25px; background:rgba(255,255,255,0.2); color:white;" onclick="toggleFavorite(${hero.id})">
                        ${favorites.includes(hero.id) ? '‚úì –í —Å–ø–∏—Å–∫–µ' : '+ –ú–æ–π —Å–ø–∏—Å–æ–∫'}
                    </button>
                </div>
            </div>
        </div>

        <p class="section-title">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–µ–Ω–∏–µ</p>
        <div class="horizontal-scroll no-scrollbar">
            ${IDIOM_DATA.map(idiom => `
                <div class="continue-card" onclick="renderDetail(${idiom.id})">
                    <div class="continue-thumb" style="background-image: url('${idiom.image}');"></div>
                    <div style="padding:10px; font-size:12px; font-weight:bold;">${idiom.text}</div>
                </div>
            `).join('')}
        </div>
    `;
}

function renderCatalog() {
    const container = document.getElementById('idiom-list');
    container.innerHTML = `<h2 style="margin-top:40px;">–í—Å–µ –∏–¥–∏–æ–º—ã</h2>
        <div class="catalog-grid">
            ${IDIOM_DATA.map(idiom => `
                <div class="catalog-item" onclick="renderDetail(${idiom.id})">
                    <img src="${idiom.image}">
                    <p>${idiom.text}</p>
                </div>
            `).join('')}
        </div>`;
}

function renderFavorites() {
    const container = document.getElementById('favorites-list');
    const favData = IDIOM_DATA.filter(i => favorites.includes(i.id));
    
    if(favData.length === 0) {
        container.innerHTML = `<div style="text-align:center; margin-top:100px; color:#666;">
            <p style="font-size:40px;">‚ûï</p><p>–í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç</p></div>`;
    } else {
        container.innerHTML = `<h2 style="margin-top:40px;">–ú–æ–π —Å–ø–∏—Å–æ–∫</h2>
            <div class="catalog-grid">${favData.map(idiom => `
                <div class="catalog-item" onclick="renderDetail(${idiom.id})">
                    <img src="${idiom.image}">
                    <p>${idiom.text}</p>
                </div>`).join('')}</div>`;
    }
}

function renderDetail(id) {
    const idiom = IDIOM_DATA.find(i => i.id === id);
    const detail = document.getElementById('screen-detail');
    detail.innerHTML = `
        <button onclick="showScreen('dashboard')" style="background:none; color:white; font-size:24px; border:none; padding:20px 0; cursor:pointer;">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="width:100%; height:200px; border-radius:8px; background: #222 url('${idiom.image}') center/cover; margin-bottom: 20px;"></div>
        <div style="display:flex; justify-content:space-between; align-items:center;">
             <h2 style="margin:0;">${idiom.text} <span class="audio-btn" onclick="playAudio('${idiom.audio_main}')">üîä</span></h2>
             <button onclick="toggleFavorite(${idiom.id}); renderDetail(${idiom.id})" style="background:none; border:none; color:white; font-size:24px;">
                ${favorites.includes(idiom.id) ? '‚úì' : '+'}
             </button>
        </div>
        <p style="color:#aaa; margin-bottom:20px;">${idiom.meaning}</p>
        <div style="background:#333; padding:15px; border-radius:4px; margin-bottom:30px; border-left:4px solid #E50914;">
            <strong>–ü—Ä–∏–º–µ—Ä:</strong><br>${idiom.example} <span class="audio-btn" onclick="playAudio('${idiom.audio_example}')">üîä</span>
        </div>
        <div class="exercise-grid">${idiom.exercises.map(ex => renderExercise(ex, idiom)).join('')}</div>
    `;
    showScreen('detail');
}

function renderExercise(ex, idiom) {
    let content = '';
    if (ex.type === "–í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è" || ex.type === "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç") {
        const diag = ex.dialogue ? `<p style="color:#888; font-style:italic; margin-bottom:10px;">${ex.dialogue}</p>` : '';
        content = diag + ex.options.map(opt => `
            <label class="radio-options" onclick="selectRadio(this)">
                <input type="radio" name="${ex.id}" value="${opt}"> <span>${opt}</span>
            </label>`).join('');
    } else if (ex.type === "–í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞") {
        content = `<p>${ex.prompt}</p><input type="text" id="in-${ex.id}" style="width:100%; padding:14px; background:#141414; color:#fff; border:1px solid #444; border-radius:4px;">`;
    } else if (ex.type === "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä") {
        content = `<div class="sentence-area" id="res-${ex.id}"></div>
                   <div class="word-bank">${ex.words.map(w => `<button class="word-chip" onclick="moveWord(this, '${ex.id}')">${w}</button>`).join('')}</div>`;
    }
    return `<div class="exercise-block" id="block-${ex.id}"><h4>${ex.type}</h4><p>${ex.question}</p>${content}<div id="feed-${ex.id}"></div><button class="check-btn" onclick="checkAnswer('${ex.id}', ${idiom.id})">–ü–†–û–í–ï–†–ò–¢–¨</button></div>`;
}

function selectRadio(el) {
    el.parentElement.querySelectorAll('.radio-options').forEach(r => r.classList.remove('selected-radio'));
    el.classList.add('selected-radio');
    el.querySelector('input').checked = true;
}

function moveWord(btn, id) {
    const area = document.getElementById(`res-${id}`);
    const bank = btn.closest('.exercise-block').querySelector('.word-bank');
    (btn.parentElement === area ? bank : area).appendChild(btn);
}

function checkAnswer(exId, idiomId) {
    const idiom = IDIOM_DATA.find(i => i.id === idiomId);
    const ex = idiom.exercises.find(e => e.id === exId);
    const block = document.getElementById(`block-${exId}`);
    const feed = document.getElementById(`feed-${exId}`);
    let correct = false;

    if (ex.type === "–í—ã–±–æ—Ä –∑–Ω–∞—á–µ–Ω–∏—è" || ex.type === "–†–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç") {
        const sel = block.querySelector('input:checked');
        correct = sel && sel.value === ex.answer;
    } else if (ex.type === "–í—Å—Ç–∞–≤–∫–∞ —Å–ª–æ–≤–∞") {
        correct = document.getElementById(`in-${exId}`).value.trim().toLowerCase() === ex.answer.toLowerCase();
    } else if (ex.type === "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä") {
        correct = Array.from(document.getElementById(`res-${exId}`).children).map(c => c.innerText).join(' ') === ex.answer;
    }

    feed.innerHTML = correct ? '<span class="correct">‚úÖ –í–µ—Ä–Ω–æ!</span>' : '<span style="color:#E50914; display:block; margin-top:10px;">‚ùå –û—à–∏–±–∫–∞</span>';
}

document.querySelectorAll('#bottom-nav button').forEach(b => {
    b.onclick = () => showScreen(b.dataset.screen);
});

showScreen('dashboard');
